# Grafana - Visualization UI with VictoriaMetrics Datasource
# Chart: grafana from grafana/grafana

# Admin credentials
admin:
  existingSecret: ""
  userKey: admin-user
  passwordKey: admin-password

# Persistence
persistence:
  enabled: true
  storageClassName: mayastor-2
  size: 5Gi

# Resources
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Replicas
replicas: 1

# Service
service:
  enabled: true
  type: ClusterIP
  port: 80
  targetPort: 3000

# Grafana configuration
grafana.ini:
  server:
    root_url: https://grafana.shreck.co.uk
    serve_from_sub_path: false

  security:
    disable_gravatar: true

  auth:
    disable_login_form: false
    disable_signout_menu: false

  auth.anonymous:
    enabled: false

  users:
    allow_sign_up: false
    auto_assign_org: true
    auto_assign_org_role: Viewer

  analytics:
    reporting_enabled: false
    check_for_updates: false

  log:
    mode: console
    level: info

# Datasources - VictoriaMetrics
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: VictoriaMetrics
        type: prometheus
        uid: victoriametrics
        access: proxy
        url: http://victoria-metrics-single-server.monitoring.svc:8428
        jsonData:
          httpMethod: POST
          timeInterval: 30s
        isDefault: true
        editable: false

# Dashboard providers
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

      - name: 'kubernetes'
        orgId: 1
        folder: 'Kubernetes'
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/kubernetes

# Dashboards to import
dashboards:
  kubernetes:
    # Node Exporter Full dashboard
    node-exporter:
      gnetId: 1860
      revision: 37
      datasource: VictoriaMetrics

    # Kubernetes Cluster Monitoring
    k8s-cluster:
      gnetId: 7249
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes Pod Resources
    k8s-pods:
      gnetId: 6417
      revision: 1
      datasource: VictoriaMetrics

# Plugins
plugins:
  - grafana-piechart-panel

# RBAC
rbac:
  create: true
  pspEnabled: false

# Service Account
serviceAccount:
  create: true
  name: grafana

# Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 472
  runAsGroup: 472
  fsGroup: 472

# Liveness probe
livenessProbe:
  httpGet:
    path: /api/health
    port: 3000
  initialDelaySeconds: 60
  timeoutSeconds: 30
  failureThreshold: 10

# Readiness probe
readinessProbe:
  httpGet:
    path: /api/health
    port: 3000
  initialDelaySeconds: 30
  timeoutSeconds: 30
