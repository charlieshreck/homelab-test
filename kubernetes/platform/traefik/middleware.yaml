# ---
# Description: This file contains Traefik middleware configurations for the homelab.
# ---

# Middleware to redirect all HTTP traffic to HTTPS
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: https-redirect
  namespace: traefik
spec:
  redirectScheme:
    scheme: https
    permanent: true

---
# Middleware to add common security headers to responses
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: default-headers
  namespace: traefik
spec:
  headers:
    # Enable security headers
    frameDeny: true
    sslRedirect: true
    browserXssFilter: true
    contentTypeNosniff: true
    forceSTSHeader: true
    # Add STS header with a max age of 1 year
    stsIncludeSubdomains: true
    stsPreload: true
    stsSeconds: 31536000
    # Set custom frame options
    customFrameOptionsValue: SAMEORIGIN
    # Add a custom request header to indicate the protocol
    customRequestHeaders:
      X-Forwarded-Proto: https

---
# Middleware for basic rate limiting to prevent abuse
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: traefik
spec:
  rateLimit:
    # Average of 100 requests per second
    average: 100
    # Burst of 50 requests
    burst: 50

---
# Example Middleware Chain to combine multiple middlewares
# You can use this to apply a standard set of middlewares to your ingresses.
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: default-chain
  namespace: traefik
spec:
  chain:
    middlewares:
      - name: https-redirect
      - name: default-headers
      - name: rate-limit
