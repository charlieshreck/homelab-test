# Robusta.dev - Kubernetes Troubleshooting & Auto-Remediation
# Version: 0.12.0

# Robusta runner configuration
runner:
  replicas: 1

  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi

# Global configuration
globalConfig:
  # Cluster name for identification
  cluster_name: homelab-talos

  # Signing key for webhooks (change this!)
  signing_key: changeme-temp-signing-key

  # Account ID (use built-in for self-hosted)
  account_id: "self-hosted"

# Playbooks configuration
playbooksConfig:
  # =============================================================================
  # PHASE 1: SAFE PLAYBOOKS (notifications only, no auto-remediation)
  # =============================================================================

  # Global playbooks (apply to all alerts)
  global_config:
    # Send all alerts to notification sinks
    - triggers:
        - on_prometheus_alert: {}
      actions:
        - name: event_logging
          params:
            log_level: INFO

  # Kubernetes event monitoring
  - triggers:
      - on_pod_oom_killed: {}
    actions:
      - name: logs_enricher
        params:
          warn_on_missing_label: false
      - name: pod_events_enricher
      - name: prometheus_enricher
        params:
          predefined_query: "container_memory_working_set_bytes"
      - name: event_logging
        params:
          log_level: WARNING

  # CrashLoopBackOff detection
  - triggers:
      - on_pod_crash_loop: {}
    actions:
      - name: logs_enricher
        params:
          warn_on_missing_label: false
          max_log_bytes: 8192
      - name: pod_events_enricher
      - name: event_logging
        params:
          log_level: ERROR

  # Node pressure alerts
  - triggers:
      - on_prometheus_alert:
          alert_name: NodeMemoryPressure
    actions:
      - name: node_enricher
      - name: prometheus_enricher
        params:
          predefined_query: "node_memory_MemAvailable_bytes"
      - name: event_logging
        params:
          log_level: WARNING

  # Mayastor-specific playbooks
  - triggers:
      - on_prometheus_alert:
          alert_name: MayastorEtcdNoLeader
    actions:
      - name: prometheus_enricher
        params:
          custom_query: "etcd_server_has_leader"
      - name: logs_enricher
        params:
          namespace: mayastor
          label_selector: "app.kubernetes.io/name=etcd"
          max_log_bytes: 16384
      - name: event_logging
        params:
          log_level: CRITICAL

  - triggers:
      - on_prometheus_alert:
          alert_name: MayastorPoolDegraded
    actions:
      - name: prometheus_enricher
        params:
          custom_query: "diskpool_status"
      - name: event_logging
        params:
          log_level: CRITICAL

  # =============================================================================
  # PHASE 2+: AUTO-REMEDIATION PLAYBOOKS (disabled by default, uncomment to enable)
  # =============================================================================

  # AUTO-RESTART OOMKilled pods (SAFE - StatefulSets recreate automatically)
  # - triggers:
  #     - on_pod_oom_killed: {}
  #   actions:
  #     - name: pod_delete
  #       params:
  #         grace_period_seconds: 30
  #     - name: event_logging
  #       params:
  #         log_level: WARNING
  #         message: "Auto-restarted OOMKilled pod: ${pod_name}"

  # AUTO-RESTART CrashLoopBackOff after 5+ crashes (MODERATE RISK)
  # - triggers:
  #     - on_pod_crash_loop:
  #         restart_count: 5
  #   actions:
  #     - name: pod_delete
  #       params:
  #         grace_period_seconds: 0
  #     - name: event_logging
  #       params:
  #         log_level: WARNING
  #         message: "Auto-restarted CrashLoopBackOff pod after 5+ crashes: ${pod_name}"

# Sinks configuration (notification channels)
sinksConfig:
  # Console logging (always enabled)
  - console_sink:
      name: console_sink
      default: true

  # Slack (configure if needed)
  # - slack_sink:
  #     name: main_slack_sink
  #     slack_channel: "#alerts"
  #     api_key: "xoxb-YOUR-SLACK-TOKEN"

  # Discord (configure if needed)
  # - discord_sink:
  #     name: main_discord_sink
  #     url: "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"

  # Microsoft Teams (configure if needed)
  # - ms_teams_sink:
  #     name: main_teams_sink
  #     webhook_url: "https://outlook.office.com/webhook/YOUR_WEBHOOK_URL"

# Service Account
serviceAccount:
  create: true
  name: robusta

# RBAC
rbac:
  create: true

# Enable Prometheus integration
enablePrometheusStack: true

# Prometheus URL (for enrichment queries)
prometheusUrl: http://mimir-nginx.monitoring.svc:80/prometheus

# Additional environment variables
extraEnv:
  - name: LOG_LEVEL
    value: "INFO"

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  capabilities:
    drop:
      - ALL

# Affinity
affinity: {}

# Tolerations
tolerations: []

# Node selector
nodeSelector: {}
