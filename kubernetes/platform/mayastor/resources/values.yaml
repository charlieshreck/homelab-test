# Mayastor configuration for 3-node cluster with dual NICs
# Storage network: 10.11.0.0/24

# IO Engine configuration (data plane)
io_engine:
  # Huge pages (configured in Talos with vm.nr_hugepages=1024)
  hugepages:
    enabled: true
  # Resource limits per Mayastor best practices
  # Workers have 4 cores each, allowing 2 for IO engine + 2 for workloads
  resources:
    limits:
      cpu: "2"              # 2 dedicated CPU cores per node (Mayastor recommended)
      memory: "2Gi"
      hugepages-2Mi: "2Gi"  # 1024 x 2MiB huge pages
    requests:
      cpu: "2"
      memory: "2Gi"
      hugepages-2Mi: "2Gi"
  # Target specific CPU cores for better performance (optional)
  # Uncomment and adjust based on your CPU topology
  # coreList: "2,3"  # Use cores 2 and 3

# Use all 3 worker nodes for Mayastor
agents:
  core:
    nodeSelector:
      openebs.io/engine: mayastor

# Storage pool configuration
# Each worker has a dedicated disk /dev/sdb for Mayastor (helford storage - 1TB total, ~300GB per node)
# DiskPools are automatically created via diskpools.yaml (deployed by ArgoCD)

# Resource limits appropriate for 9GB RAM per node
csi:
  node:
    resources:
      limits:
        cpu: "1"
        memory: "512Mi"
      requests:
        cpu: "100m"
        memory: "128Mi"

# Enable etcd for Mayastor control plane
# Use tmpfs-backed storage to ensure clean state on every restart
etcd:
  replicaCount: 3
  persistence:
    enabled: false

  # Use tmpfs for truly ephemeral data directory
  extraVolumes:
    - name: etcd-data-tmpfs
      emptyDir:
        medium: Memory
        sizeLimit: 512Mi

  extraVolumeMounts:
    - name: etcd-data-tmpfs
      mountPath: /bitnami/etcd/data

  extraEnvVars:
    - name: ETCD_HEARTBEAT_INTERVAL
      value: "250"
    - name: ETCD_ELECTION_TIMEOUT
      value: "1250"

  resources:
    limits:
      cpu: "500m"
      memory: "512Mi"
    requests:
      cpu: "100m"
      memory: "256Mi"

  pdb:
    create: true
    minAvailable: 2

# Disable Loki (observability) - also needs storage, not required for core functionality
loki:
  enabled: false

# Enable metrics
metrics:
  enabled: true
