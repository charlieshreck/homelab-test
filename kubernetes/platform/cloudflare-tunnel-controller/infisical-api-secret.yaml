# Sync Cloudflare API credentials from Infisical
# This secret provides the API credentials needed by the tunnel controller
# Uses secrets from /kubernetes/ path:
# - CLOUDFLARE_TUNNEL_API_TOKEN (API token)
# - CLOUDFLARE_ACCOUNT_ID (Cloudflare account ID)
# - CLOUDFLARE_TUNNEL_NAME (tunnel name)
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: cloudflare-api
  namespace: cloudflare-tunnel-controller
spec:
  hostAPI: https://app.infisical.com/api

  authentication:
    universalAuth:
      credentialsRef:
        secretName: "universal-auth-credentials"
        secretNamespace: "infisical-operator-system"
      secretsScope:
        projectSlug: "homelab-test-5-ig-k"
        envSlug: "prod"
        secretsPath: "/kubernetes"

  managedSecretReference:
    secretName: cloudflare-api
    secretNamespace: cloudflare-tunnel-controller
    secretType: Opaque
    creationPolicy: Owner

  # Map Infisical keys to deployment expectations
  secretKeyMapping:
    - from: CLOUDFLARE_API_TOKEN
      to: api-token
    - from: CLOUDFLARE_ACCOUNT_ID
      to: cloudflare-account-id
    - from: CLOUDFLARE_TUNNEL_ID
      to: cloudflare-tunnel-name
