apiVersion: apps/v1
kind: Deployment
metadata:
  name: homepage
  namespace: apps
  labels:
    app.kubernetes.io/name: homepage
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: homepage
  template:
    metadata:
      labels:
        app.kubernetes.io/name: homepage
    spec:
      serviceAccountName: homepage
      automountServiceAccountToken: true
      dnsPolicy: ClusterFirst
      enableServiceLinks: true
      securityContext:
        fsGroup: 1000
      initContainers:
        - name: copy-config
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              cp -rL /tmp/config/* /app/config/ && \
              chmod -R 755 /app/config && \
              chown -R 1000:1000 /app/config
          volumeMounts:
            - name: homepage-config-source
              mountPath: /tmp/config
            - name: homepage-config
              mountPath: /app/config
          securityContext:
            runAsUser: 0
      containers:
        - name: homepage
          image: ghcr.io/gethomepage/homepage:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          env:
            - name: HOMEPAGE_ALLOWED_HOSTS
              value: "homepage.shreck.co.uk"
            - name: HOMEPAGE_VAR_RADARR_API_KEY
              valueFrom:
                secretKeyRef:
                  name: homepage-radarr
                  key: API_KEY
            - name: HOMEPAGE_VAR_SONARR_API_KEY
              valueFrom:
                secretKeyRef:
                  name: homepage-sonarr
                  key: API_KEY
                  optional: true
            - name: HOMEPAGE_VAR_OVERSEERR_API_KEY
              valueFrom:
                secretKeyRef:
                  name: homepage-overseerr
                  key: API_KEY
                  optional: true
            - name: HOMEPAGE_VAR_PROWLARR_API_KEY
              valueFrom:
                secretKeyRef:
                  name: homepage-prowlarr
                  key: API_KEY
                  optional: true
            - name: HOMEPAGE_VAR_SABNZBD_API_KEY
              valueFrom:
                secretKeyRef:
                  name: homepage-sabnzbd
                  key: API_KEY
                  optional: true
            - name: HOMEPAGE_VAR_TRANSMISSION_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: homepage-transmission
                  key: PASSWORD
                  optional: true
          volumeMounts:
            - name: homepage-config
              mountPath: /app/config
            - name: mayastor-stats
              mountPath: /app/mayastor
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
        - name: mayastor-monitor
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              while true; do
                # Query DiskPool CRDs and aggregate stats
                POOLS_JSON=$(kubectl get diskpools -n mayastor -o json 2>/dev/null)

                if [ $? -eq 0 ]; then
                  # Calculate totals using jq
                  TOTAL_CAPACITY=$(echo "$POOLS_JSON" | jq -r '[.items[].status.capacity // 0] | add')
                  TOTAL_USED=$(echo "$POOLS_JSON" | jq -r '[.items[].status.used // 0] | add')
                  TOTAL_AVAILABLE=$(echo "$POOLS_JSON" | jq -r '[.items[].status.available // 0] | add')

                  # Check if any pool is degraded/faulted
                  DEGRADED_COUNT=$(echo "$POOLS_JSON" | jq -r '[.items[].status.pool_status] | map(select(. != "Online")) | length')

                  # Create a mock filesystem stats file for Homepage resources widget
                  # Homepage expects disk usage in a specific format
                  mkdir -p /shared

                  # Calculate percentages
                  if [ "$TOTAL_CAPACITY" -gt 0 ]; then
                    USED_PERCENT=$((TOTAL_USED * 100 / TOTAL_CAPACITY))
                  else
                    USED_PERCENT=0
                  fi

                  # Write stats as JSON for Homepage custom API widget
                  TOTAL_FMT=$(numfmt --to=iec-i --suffix=B $TOTAL_CAPACITY)
                  USED_FMT=$(numfmt --to=iec-i --suffix=B $TOTAL_USED)
                  AVAIL_FMT=$(numfmt --to=iec-i --suffix=B $TOTAL_AVAILABLE)
                  STATUS=$([ "$DEGRADED_COUNT" -eq 0 ] && echo 'All Online' || echo "$DEGRADED_COUNT Degraded/Faulted")

                  # Write JSON file
                  echo "{\"total\":\"$TOTAL_FMT\",\"used\":\"$USED_FMT ($USED_PERCENT%)\",\"available\":\"$AVAIL_FMT\",\"status\":\"$STATUS\"}" > /shared/stats.json

                  echo "Updated Mayastor stats at $(date)"
                else
                  echo "Failed to query DiskPools at $(date)"
                fi

                sleep 30
              done
          volumeMounts:
            - name: mayastor-stats
              mountPath: /shared
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
        - name: stats-server
          image: python:3.11-alpine
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              cd /shared
              python3 -m http.server 8080
          ports:
            - name: stats
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: mayastor-stats
              mountPath: /shared
          resources:
            requests:
              cpu: 5m
              memory: 16Mi
            limits:
              cpu: 20m
              memory: 32Mi
      volumes:
        - name: homepage-config-source
          configMap:
            name: homepage
        - name: homepage-config
          emptyDir: {}
        - name: mayastor-stats
          emptyDir: {}
        - name: logs
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: homepage
  namespace: apps
  labels:
    app.kubernetes.io/name: homepage
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: homepage
